{% extends 'base.html' %}

{% load static %}

{% block title %}
  Account Settings
{% endblock title %}

{% block header %}
  <h1 class="mt-4 md:ml-5 pb-2 md:text-left text-center font-bold text-3xl">Settings</h1>
{% endblock header %}

{% block content %}
  <div class="p-5 bg-[#dcdbdb] min-h-screen">
    <div class="w-full bg-white rounded-xl shadow-md overflow-hidden p-8 mb-6">
      <div class="flex items-center gap-6 w-full mx-auto">
        <div class="flex-shrink-0">
          <img class="w-[60px] h-[60px] xl:w-[96px] xl:h-[96px]" src="{{ user.profile_picture.url }}" alt="User profile picture">
        </div>
        
        <div class="flex-1 min-w-0">
          <h2 class="text-2xl xl:text-3xl font-bold text-black mb-2 xl:mb-3 break-words">
            {% if user.is_admin %}
              Administrator
            {% else %}
              {{ user.first_name }} {% if user.middle_name %} {{ user.middle_name }} {% endif %} {{ user.last_name }}
            {% endif %}
          </h2>
          
          <div class="text-black xl:text-lg break-words flex items-center mb-2 group">
            <span class="font-medium">EMAIL:</span>
            <span id="current-email" class="ml-1">{{ user.email }}</span>
            <button id="edit-email-btn" class="ml-2">
              <i class="fa-solid fa-pencil-alt text-sm text-gray-500 hover:text-[#F95858] transition-colors"></i>
            </button>
          </div>
          
          {% if not user.is_admin %}
            <div class="text-black xl:text-lg break-words flex items-center group">
              <span class="font-medium">PHONE:</span>
              <span id="current-phone" class="ml-1">{{ driver_profile.contact_number }}</span>
              <button id="edit-phone-btn" class="ml-2">
                <i class="fa-solid fa-pencil-alt text-sm text-gray-500 hover:text-[#F95858] transition-colors"></i>
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="w-full bg-white rounded-xl shadow-md overflow-hidden p-8 mb-6">
      <h2 class="text-2xl font-bold text-black">Vehicle Details</h2>
      <hr class="mb-6 border-gray-300">
      
      {% for vehicle in vehicles %}
        <h2 class="ml-10 font-bold text-black">Vehicle 1</h2>
        <hr class="ml-10 mr-10 mb-6 border-gray-300">

        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <tbody class="text-black">
              <tr>
                <td class="py-2 pl-10 font-semibold w-1/3">Plate Number</td>
                <td class="py-2 pl-10 plate">{{ vehicle.plate_number }}</td>
              </tr>
              <tr>
                <td class="py-2 pl-10 font-semibold">Brand</td>
                <td class="py-2 pl-10 brand">{{ vehicle.brand }}</td>
              </tr>
              <tr>
                <td class="py-2 pl-10 font-semibold">Model</td>
                <td class="py-2 pl-10 model">{{ vehicle.model }}</td>
              </tr>
              <tr>
                <td class="py-2 pl-10 font-semibold">Vehicle Type</td>
                <td class="py-2 pl-10 type">{{ vehicle.vehicle_type }}</td>
              </tr>
              <tr>
                <td class="py-2 pl-10 font-semibold">Color</td>
                <td class="py-2 pl-10 color">{{ vehicle.color }}</td>
              </tr>
              <tr>
                <td class="py-2 pl-10 font-semibold">Gate Pass</td>
                <td class="py-2 pl-10 gate">{{ vehicle.gate_pass }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Edit Button -->
        <div class="flex justify-end mt-6">
          <button class="edit-vehicle-btn bg-[#9D0E15] hover:bg-red-700 text-white px-6 py-2 rounded-md shadow-md">
            Edit
          </button>
        </div>
      {% endfor %}
    </div>


    <div id="email-edit-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-md"></div>
      <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 relative z-10 shadow-lg">
        <h3 class="text-lg font-semibold mb-4">Update Email Address</h3>
        <input type="email" id="new-email" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-[#7cd1f9] outline-none" placeholder="Enter new email address">
        <div class="flex justify-end gap-3">
          <button id="cancel-email-edit-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">Cancel</button>
          <button id="save-email-btn" class="px-4 py-2 bg-[#7cd1f9] text-white rounded-lg hover:bg-[#78cbf2] transition-colors">Save</button>
        </div>
      </div>
    </div>

    <div id="phone-edit-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-md"></div>
      <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 relative z-10 shadow-lg">
        <h3 class="text-lg font-semibold mb-4">Update Phone Number</h3>
        <input type="tel" id="new-phone" class="w-full p-3 border rounded-lg mb-4" placeholder="Enter new phone number">
        <div class="flex justify-end gap-3">
          <button id="cancel-edit-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
            Cancel
          </button>
          <button id="save-phone-btn" class="px-4 py-2 bg-[#7cd1f9] text-white rounded-lg hover:bg-[#78cbf2] transition-colors">
            Save
          </button>
        </div>
      </div>
    </div>

    <div id="vehicle-edit-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-md"></div>
      <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 relative z-10 shadow-lg">
        <h3 class="text-lg font-semibold mb-4">Edit Vehicle Details</h3>

        <form id="vehicle-edit-form" class="space-y-4">
          <input type="hidden" id="vehicle-id">

          <div>
            <label class="block text-sm font-medium">Plate Number</label>
            <input type="text" id="edit-plate" class="w-full p-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Brand</label>
            <input type="text" id="edit-brand" class="w-full p-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Model</label>
            <input type="text" id="edit-model" class="w-full p-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Vehicle Type</label>
            <input type="text" id="edit-type" class="w-full p-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Color</label>
            <input type="text" id="edit-color" class="w-full p-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Gate Pass</label>
            <input type="text" id="edit-gate" class="w-full p-2 border rounded-lg" required>
          </div>

          <div class="flex justify-end gap-3 mt-4">
            <button type="button" id="cancel-vehicle-edit-btn" 
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Cancel</button>
            <button type="button" id="save-vehicle-btn" 
                    class="px-4 py-2 bg-[#7cd1f9] text-white rounded-lg hover:bg-[#78cbf2]">Save</button>
          </div>
        </form>
      </div>
    </div>


  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // ===================== PHONE =====================
    const editPhoneBtn = document.getElementById('edit-phone-btn');
    const phoneModal = document.getElementById('phone-edit-modal');
    const cancelPhoneBtn = document.getElementById('cancel-edit-btn');
    const savePhoneBtn = document.getElementById('save-phone-btn');
    const currentPhone = document.getElementById('current-phone');
    const newPhoneInput = document.getElementById('new-phone');

    if (editPhoneBtn) {
      editPhoneBtn.addEventListener('click', function() {
        newPhoneInput.value = currentPhone.innerText.trim();
        phoneModal.classList.remove('hidden');
      });
    }

    if (cancelPhoneBtn) {
      cancelPhoneBtn.addEventListener('click', function() {
        phoneModal.classList.add('hidden');
      });
    }

    if (savePhoneBtn) {
      savePhoneBtn.addEventListener('click', function() {
        const newNumber = newPhoneInput.value.trim();
        if (newNumber) {
          currentPhone.innerText = newNumber;
          phoneModal.classList.add('hidden');
        }
      });
    }

    // ===================== EMAIL =====================
    const editEmailBtn = document.getElementById('edit-email-btn');
    const emailModal = document.getElementById('email-edit-modal');
    const cancelEmailBtn = document.getElementById('cancel-email-edit-btn');
    const saveEmailBtn = document.getElementById('save-email-btn');
    const currentEmail = document.getElementById('current-email');
    const newEmailInput = document.getElementById('new-email');

    if (editEmailBtn) {
      editEmailBtn.addEventListener('click', function() {
        newEmailInput.value = currentEmail.innerText.trim();
        emailModal.classList.remove('hidden');
      });
    }

    if (cancelEmailBtn) {
      cancelEmailBtn.addEventListener('click', function() {
        emailModal.classList.add('hidden');
      });
    }

    if (saveEmailBtn) {
      saveEmailBtn.addEventListener('click', function() {
        const newEmail = newEmailInput.value.trim();
        if (newEmail) {
          currentEmail.innerText = newEmail;
          emailModal.classList.add('hidden');
        }
      });
    }

      // ===================== VEHICLE =====================
      const editVehicleBtns = document.querySelectorAll('.edit-vehicle-btn'); 
      const vehicleModal = document.getElementById('vehicle-edit-modal');
      const cancelVehicleBtn = document.getElementById('cancel-vehicle-edit-btn');
      const saveVehicleBtn = document.getElementById('save-vehicle-btn');

      const vehicleForm = {
        plate: document.getElementById('edit-plate'),
        brand: document.getElementById('edit-brand'),
        model: document.getElementById('edit-model'),
        type: document.getElementById('edit-type'),
        color: document.getElementById('edit-color'),
        gate: document.getElementById('edit-gate'),
      };

      let activeVehicleRow = null;

      editVehicleBtns.forEach((btn) => {
        btn.addEventListener('click', function() {
          activeVehicleRow = this.closest('div').previousElementSibling.querySelector('tbody');
          vehicleForm.plate.value = activeVehicleRow.querySelector('.plate').innerText.trim();
          vehicleForm.brand.value = activeVehicleRow.querySelector('.brand').innerText.trim();
          vehicleForm.model.value = activeVehicleRow.querySelector('.model').innerText.trim();
          vehicleForm.type.value = activeVehicleRow.querySelector('.type').innerText.trim();
          vehicleForm.color.value = activeVehicleRow.querySelector('.color').innerText.trim();
          vehicleForm.gate.value = activeVehicleRow.querySelector('.gate').innerText.trim();
          vehicleModal.classList.remove('hidden');
        });
      });

      if (cancelVehicleBtn) {
        cancelVehicleBtn.addEventListener('click', function() {
          vehicleModal.classList.add('hidden');
        });
      }

      if (saveVehicleBtn) {
        saveVehicleBtn.addEventListener('click', function() {
          if (activeVehicleRow) {
            activeVehicleRow.querySelector('.plate').innerText = vehicleForm.plate.value;
            activeVehicleRow.querySelector('.brand').innerText = vehicleForm.brand.value;
            activeVehicleRow.querySelector('.model').innerText = vehicleForm.model.value;
            activeVehicleRow.querySelector('.type').innerText = vehicleForm.type.value;
            activeVehicleRow.querySelector('.color').innerText = vehicleForm.color.value;
            activeVehicleRow.querySelector('.gate').innerText = vehicleForm.gate.value;
            vehicleModal.classList.add('hidden');
          }
        });
      }
  });
</script>

{% endblock %}